<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Evidence Save - NABH</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    button { background: #1565C0; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
    button:hover { background: #0D47A1; }
    .result { margin-top: 20px; padding: 15px; border-radius: 5px; }
    .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
    h1 { color: #1565C0; }
  </style>
</head>
<body>
  <h1>üîç NABH Evidence Database Test</h1>
  <p>This page tests if the Supabase database migration was successful.</p>

  <button onclick="testSaveEvidence()">üìù Test Save Evidence</button>
  <button onclick="testLoadEvidences()">üìÇ Test Load Evidences</button>
  <button onclick="clearResults()">üóëÔ∏è Clear Results</button>

  <div id="result"></div>

  <script>
    const SUPABASE_URL = 'https://aynoltymgusyasgxshng.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5bm9sdHltZ3VzeWFzZ3hzaG5nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NjM2MjAsImV4cCI6MjA4MzUzOTYyMH0.lYEyeEkTdg3Y-ZFnvWFown_ntLBk4pj2Iq4JA7FYWoY';

    function showResult(message, isSuccess) {
      const resultDiv = document.getElementById('result');
      resultDiv.className = 'result ' + (isSuccess ? 'success' : 'error');
      resultDiv.innerHTML = message;
    }

    function clearResults() {
      document.getElementById('result').innerHTML = '';
    }

    async function testSaveEvidence() {
      try {
        showResult('‚è≥ Testing evidence save...', true);

        const testEvidence = {
          objective_code: 'TEST.1.1',
          evidence_title: 'Test Evidence Document',
          prompt: 'Test prompt for evidence generation',
          generated_content: 'This is test content',
          html_content: '<html><body><h1>Test Evidence</h1></body></html>',
          evidence_type: 'document',
          hospital_config: {
            name: 'Hope Hospital',
            address: 'Test Address',
            phone: '1234567890',
            email: 'test@hospital.com',
            website: 'https://hospital.com',
            qualityCoordinator: 'Dr. Shiraz Sheikh',
            qualityCoordinatorDesignation: 'NABH Coordinator'
          }
        };

        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/nabh_ai_generated_evidence`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Prefer': 'return=representation',
            },
            body: JSON.stringify(testEvidence),
          }
        );

        const responseText = await response.text();

        if (!response.ok) {
          showResult(`‚ùå <strong>Save Failed!</strong><br><br>Status: ${response.status}<br><br><pre>${responseText}</pre>`, false);
          return;
        }

        const data = JSON.parse(responseText);
        showResult(`‚úÖ <strong>Save Successful!</strong><br><br>Evidence saved with ID: <code>${data[0].id}</code><br><br><pre>${JSON.stringify(data[0], null, 2)}</pre>`, true);

      } catch (error) {
        showResult(`‚ùå <strong>Error:</strong> ${error.message}`, false);
      }
    }

    async function testLoadEvidences() {
      try {
        showResult('‚è≥ Loading evidences...', true);

        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/nabh_ai_generated_evidence?objective_code=eq.TEST.1.1&order=created_at.desc`,
          {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            },
          }
        );

        const responseText = await response.text();

        if (!response.ok) {
          showResult(`‚ùå <strong>Load Failed!</strong><br><br>Status: ${response.status}<br><br><pre>${responseText}</pre>`, false);
          return;
        }

        const data = JSON.parse(responseText);
        showResult(`‚úÖ <strong>Load Successful!</strong><br><br>Found ${data.length} evidence(s) for objective TEST.1.1<br><br><pre>${JSON.stringify(data, null, 2)}</pre>`, true);

      } catch (error) {
        showResult(`‚ùå <strong>Error:</strong> ${error.message}`, false);
      }
    }
  </script>
</body>
</html>
